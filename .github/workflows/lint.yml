name: Lint

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  clang-format:
    name: Check formatting
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get source files
        id: get-files
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path "src" -Recurse -Include *.cpp,*.h,*.hpp |
            Where-Object { $_.FullName -notmatch "external" } |
            ForEach-Object { $_.FullName }
          $fileList = $files -join "`n"
          echo "files<<EOF" >> $env:GITHUB_OUTPUT
          echo $fileList >> $env:GITHUB_OUTPUT
          echo "EOF" >> $env:GITHUB_OUTPUT
          echo "Found $($files.Count) source files"

      - name: Run clang-format
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path "src" -Recurse -Include *.cpp,*.h,*.hpp |
            Where-Object { $_.FullName -notmatch "external" }

          $hasErrors = $false
          foreach ($file in $files) {
            $diff = & clang-format --dry-run --Werror $file.FullName 2>&1
            if ($LASTEXITCODE -ne 0) {
              Write-Host "::error file=$($file.FullName)::File needs formatting"
              $hasErrors = $true
            }
          }

          if ($hasErrors) {
            Write-Host "::error::Some files need formatting. Run clang-format locally."
            exit 1
          }

          Write-Host "All files are properly formatted."

  clang-tidy:
    name: Static analysis
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'a34c873a9717a888f58dc05268dea15592c2f0ff'

      - name: Configure CMake (generate compile_commands.json)
        run: |
          cmake -B build -S . `
            -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Run clang-tidy
        shell: pwsh
        run: |
          $files = Get-ChildItem -Path "src" -Recurse -Include *.cpp |
            Where-Object { $_.FullName -notmatch "external" }

          $hasErrors = $false
          foreach ($file in $files) {
            Write-Host "Analyzing $($file.Name)..."
            & clang-tidy -p build $file.FullName --quiet 2>&1
            if ($LASTEXITCODE -ne 0) {
              $hasErrors = $true
            }
          }

          if ($hasErrors) {
            Write-Host "::warning::clang-tidy reported issues"
          } else {
            Write-Host "Static analysis passed."
          }
